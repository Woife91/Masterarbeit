\chapter[Stand der Technik]{Stand der Technik}\label{sec:stand_der_technik}
Das grundsätzliche Ziel beim Einsatz von Algorithmen zur Farbnormalisierung ist, dass Objekte gleicher Farbe auch ähnliche Pixelwerte haben. Dies sollte unabhängig von der Beleuchtung im Bild sein. Beim Anwendungsfeld der Mikroskopie kommen als Faktoren zusätzlich noch Probendicke und Farbstoffmenge hinzu. Im folgenden Kapitel soll ein Überblick über bestehende Verfahren gegeben werden, wobei der Schwerpunkt, die Normalisierung auf mikroskopischen Bildern, in Abschnitt \ref{sec:mikroskopie_normalisierung} behandelt wird. Zunächst soll jedoch auf Methoden eingegangen werden, welche zwar oft eingesetzt werden, im vorliegenden Fall aufgrund der speziellen Bildakquisition jedoch ungeeignet sind. 
%\section[Allgemeine Farbnormalisierung]{Allgemeine Farbnormalisierung}%\label{sec:allgemeine_normalisierung}
%\color{red}
%Gray World Assumption, Farbkonstanz

%Referenz auf MA Bindl?
%\color{black}

\section{Farbkonstanzalgorithmen}\label{sec:farbkonstanz}
Das menschliche Gehirn ist innerhalb gewisser Grenzen in der Lage, die Farbe eines Objektes unabhängig von dessen Beleuchtung zu bestimmen. Diese Fähigkeit ist die Grundlage für eine Gruppe von Ansätzen, die als Farbkonstanzalgorithmen bezeichnet werden.

Das menschliche Auge ist das Vorbild für den sogenannten LMS-Farbraum. Die drei Kanäle entsprechen dabei den unterschiedlichen Zapfen, die auf lang-, mittel- und kurzwelliges Licht reagieren. Nach den Erkenntnissen von Johannes von Kries werden die unterschiedlichen Signale unabhängig voneinander vom Gehirn angepasst. Dieser Zusammenhang wird in der folgenden Formel \ref{equ:kries} dargestellt.
\begin{align}\label{equ:kries}
L_{a} & = k_{L}L\\
M_{a} & = k_{M}M\\
S_{a} & = k_{S}S
\end{align}
$L_{a}$, $M_{a}$ und $S_{a}$ sind hierbei die angepassten Signale. $k_{L}$, $K_{M}$ und $k_{S}$ sind hingegen die unabhängigen Skalierungsfaktoren.
%Für die Bestimmung dieser Faktoren gibt es unterschiedliche Möglichkeiten. Zum einen können sie die Inversen des angenommenen Weißpunktes der Szene sein, zum anderen als Inverse des jeweils maximalen Werts des Kanals.
Eine Annahme die gerne gemacht wird um diese Faktoren zu finden, ist die sogenannte "Grey World Assumption". Im Kern wird davon ausgegangen, dass die durchschnittliche Reflektanz in einer Szene Grau entspricht. \color{red} Achtung dies ist ein wörtliches Zitat aus MA Bindl, abklären inwieweit zitierfähig \color{black} Variationen gibt es u.a. bei der Wahl von Grau. 
Im einfachsten Fall können die Skalierungsfaktoren entsprechend \label{equ:grey_world} berechnet werden. Hierbei entspricht $m_{L1}$ dem Mittelwert des L-Kanals einer Referenzaufnahme, $m_{L2}$ dem Mittelwert des L-Kanals aus einer Testaufnahme, usw.  
\begin{align}\label{equ:grey_world}
k_{L}L & = \frac{m_{L2}}{m_{L1}}\\
k_{M}M & = \frac{m_{M2}}{m_{M1}}\\
k_{S}S & = \frac{m_{S2}}{m_{S1}}
\end{align}

Farbkonstanzmodelle treffen Annahmen über das Verhalten von reflektiertem Licht, was sie ungeeignet für die Mikroskopie macht, da hier transmittiertes Licht detektiert wird \cite{khan2014nonlinear}

\section[Farbnormalisierung in der Mikroskopie]{Farbnormalisierung in der Mikroskopie}\label{sec:mikroskopie_normalisierung}
Für Farbnormalisierung im vorliegenden Anwendungsgebiet wird in der Regel der Ansatz verfolgt, ein Bild an ein gegebenes Referenzbild anzugleichen. 
Während die Methoden in den Abschnitten \ref{sec:farbranking} und \ref{sec:color_deconvolution} eine Farbraumtransformation erfordern, benötigt das Farbranking (\ref{sec:farbranking}) keine Vorverarbeitungsschritte.

\subsection{Farbranking}\label{sec:farbranking}
Farbranking ist ein Verfahren, das von \citeeig{kothari2011automatic} eingeführt wurde. Hierbei werden zunächst die Intensitäten in allen Kanälen jeweils für das Eingangs- und Ausgangsbild sortiert. Anschließend werden für jedes Pixel zunächst die Positionen in den sortierten Listen ermittelt. Die Farbintensitäten bekommen am Ende die Werte zugewiesen, welche sich in den Listen des Referenzbildes an den gleichen Stellen befinden. Dieser Zusammenhang ist in Graphik \ref{fig:farbranking} für den Fall von Grauwertbildern mit Größe 3x3 dargestellt. Dabei entspricht Bild A dem Referenzbild und Bild B dem Eingangsbild. B' beschreibt das angepasste Ausgabebild. 

\begin{figure}[h]
\center
\includegraphics[width = 0.9\textwidth]{pics/StandTechnik/Farbranking_Ablauf}
\caption[Farbranking]{Links sind Eingangs- und Referenzbild dargestellt, in der Mitte die sortierten Listen und rechts das Ausgabebild. Die farbigen Pfeile sollen den Ablauf nach dem Erstellen der sortierten Listen verdeutlichen. Dabei wird der Pixel links oben im Bild behandelt. Rot: Finden des Pixelwertes in der sortierten Liste. Blau: Wahl des positionsgleichen Wertes aus dem Referenzbild. Grün: Übertrag dieses Wertes an die gleiche Stelle in Bild B' \label{fig:farbranking}}
\end{figure}

Die Schwächen des Verfahrens, zeigen sich vor allem, wenn sich Eingangs- und Referenzbild zu sehr unterscheiden. In diesem Fall kommt es zu Artefakten, bei denen monochrome Flächen nach der Anpassung starke Unterschiede aufweisen.

\color{red}
evtl. Beispielbild
\color{black}

\subsection[Farbtransfer nach Reinhard]{Farbtransfer nach Reinhard}\label{sec:reinhard}
\color{red}
Reinhard allgemein + Anpassung an Mikroskopie(Mikroskopische Trainingsbilder)
\color{black}
Ein andere Methode bei der die Akquisition keine Rolle spielt, wird von \color{red} Reinhard \color{black}vorgeschlagen. Das Ziel ist es, die Anpassung mit möglichst schwach korrelierenden Kanälen durchzuführen. Ein Farbraum, der diese Eigenschaft für natürliche Bilder am besten erfüllt ist der von \color{red}Rudermann\color{black}vorgeschlagene $l\alpha\beta$-Raum. Die Umrechnung erfolgt dabei in mehreren Schritten. 
\begin{itemize}
\item{RGB $\rightarrow$ XYZ(Tristimulusraum): 
\begin{equation}\label{equ:rgb_xyz}
\begin{bmatrix}
X\\Y\\Z
\end{bmatrix}
= 
\begin{bmatrix}
0.5141 & 0.3239 & 0.1604\\
0.2651 & 0.6702 & 0.0641\\
0.0241 & 0.1228 & 0.8444
\end{bmatrix}
\begin{bmatrix}
R\\G\\B
\end{bmatrix}
\end{equation}
}
\item{XYZ $\rightarrow$ LMS\ref{sec:allgemeine_normalisierung}}

\begin{equation}\label{equ:xyz_lms}
\begin{bmatrix}
L\\M\\S
\end{bmatrix}
= 
\begin{bmatrix}
0.3897 & 0.6890 & -0.0787\\
-0.2298 & 1.1834 & 0.0464\\
0.000 & 0.000 & 1.0000
\end{bmatrix}
\begin{bmatrix}
X\\Y\\Z
\end{bmatrix}
\end{equation}
\item{Logarithmus auf dem LMS-Raum}
\item{Logarithmierter LMS $\rightarrow L\alpha\beta$}

\begin{equation}\label{equ:lms_lab}
\begin{bmatrix}
L\\\alpha\\\beta
\end{bmatrix}
= 
\begin{bmatrix}
\frac{1}{\sqrt{3}} & 0 & 0\\
0 & \frac{1}{\sqrt{6}} & 0\\
0 & 0 & \frac{1}{\sqrt{2}}
\end{bmatrix}
\begin{bmatrix}
1 & 1 & 1\\
1 & 1 & -2\\
1 & -1 & 0
\end{bmatrix}
\begin{bmatrix}
log(L)\\log(M)\\log(S)
\end{bmatrix}
\end{equation}
\end{itemize}

Die Umrechnung in \ref{equ:lms_lab} basiert auf einer Hauptachsentransformation, welche von \color{red} Rudermann(muss noch in die Bibliographie)\color{black} auf einem Datensatz natürlicher Fotos durchgeführt wurde. Die Eigenvektoren der gemittelten Kovarianzmatrix finden sich in der Rotationsmatrix dieser Transformation. Reinhard(\color{red} Bibliographie\color{black}) schlägt vor, die Histogramme der dekorrelierten Kanäle einzeln anzupassen. In seinem Verfahren werden Mittelwert und Standardabweichung angepasst. \color{red} evtl. kompletten Abschnitt zu Möglichkeiten Histogramme zu beeinflussen: -Equalisation, Spezifikation, Übertrag von Features (wie hier), Bspline(wie bei Khan) \color{black}

\subsection{Color Deconvolution}\label{sec:color_deconvolution}
Die sogenannte Color Deconvolution ist spezifisch für die Pathologie bzw. Hämotologie, da hier Farbstoffe zum Einsatz kommen. Das Ziel ist es, das Bild durch eben diese Färbemittel auszudrücken. \citeeig{ruifrok2001quantification} schlagen dieses Verfahren vor, mit dem Ziel quantitative Aussagen über die Färbung machen zu können. Die maximale Anzahl verschiedener Farbstoffe ist dabei drei, da eine höhere Anzahl, den Transfer aus einem  trichromatischem Farbraum in einen höherdimensionalen Raum bedeuten würde. 

Die Absorption von Licht durch das chemische Mittel folgt dem Lambert-Beerschen-Gesetz \ref{equ:lambert_beer}, wobei $I_k$ als die Lichtintensität nach Passieren der Probe und $I_{0,k}$ vor der Probe festgelegt ist. Der Index $k$ steht für den detektierenden Kanal, also R,G oder B. $A$ entspricht der Menge an Färbemittel und  $c_k$ dem Absorptionsfaktor. 

\begin{equation}\label{equ:lambert_beer}
I_k = I_{0,k}e^{-Ac_k}
\end{equation} 

Der Zusammenhang zwischen der Menge an Farbstoff und der detektierten Intensität ist also nicht linear. Aus diesem Grund wird das Bild zunächst mit Hilfe des Logarithmus in den sogenannten OD-Raum (Optical Density) transferiert \ref{equ:od}.

\begin{equation}\label{equ:od}
OD_k = -log\left(\frac{I_k}{I_{0,k}}\right) = Ac_k
\end{equation} 


\citeeig{khan2014nonlinear} drücken die Zusammenhänge für die Color Deconvolution in Anlehnung an \citeauthor{ruifrok2001quantification} in Matrixschreibweise folgendermaßen aus:

\begin{equation}\label{equ:beer_matrix}
\Psi = e^{-\mathbf{S}\hat\Psi} 
\end{equation}

In Formel \ref{equ:beer_matrix} steht $\mathbf{S}$ für die sogenannte Stainmatrix, welche in Formel \ref{equ:stainmatrix} noch genauer beschrieben wird. Sie beinhaltet die Absorptionsfaktoren der vorkommenden Farbstoffe für die einzelnen Kanäle. $\Psi$ beschreibt den ursprünglichen Farbraum, also RGB und $\hat\Psi$ den neuen Farbraum. 

\begin{equation}\label{equ:stainmatrix}
\mathbf{S} =
\begin{bmatrix}
\bar s_{r,1} & \bar s_{g,1} & \bar s_{b,1}\\
\bar s_{r,2} & \bar s_{g,2} & \bar s_{b,2}\\
\bar s_{r,3} & \bar s_{g,3} & \bar s_{b,3}
\end{bmatrix}
\end{equation}

Formel \ref{equ:beer_matrix} lässt sich umstellen nach $\hat\Psi$ \ref{equ:color_deconvolution}

\begin{align}\label{equ:color_deconvolution}
\hat \Psi(c) & = \mathbf{D}\Phi(c) \\
\textrm{Es gelten } \mathbf{D} & = \mathbf{S}^{-1} \\
\textrm{und } \Phi(c) & = - log(\Psi(c))
\end{align}

Der hier als $\Phi$ bezeichnete Farbraum beschreibt damit den OD-Wert(\ref{equ:od}). 
Ein entscheidender Punkt bei CD liegt in der Bestimmung der Stainvektoren. In den folgenden Abschnitten \ref{sec:stains_färbung} und \ref{sec:stains_bild} werden unterschiedliche Möglichkeiten vorgestellt, diese zu bestimmen.

\subsubsection{Stainvektoren für eine Färbung}\label{sec:stains_färbung}
Ein Ansatz an die Stainvektoren für eine Färbemethode und einen Versuchsaufbau zu kommen, wird von \citeauthor{ruifrok2001quantification} vorgeschlagen. Dabei sollen Proben mit nur einem der später verwendeten Farbstoffe untersucht werden. Im OD-Raum ergibt sich an den gefärbten Stellen ein Farbvektor, bei dem die Länge linear zur Menge an Farbstoff ist. Ein eindeutiger Farbvektor ergibt sich aus diesem Grund durch Normieren des Farbvektors im OD-Raum. \citeauthor{ruifrok2001quantification} führten das Verfahren für eine Färbung mit Hämatoxylin, Eosin und DAB durch. Die Matrix vor und nach dem Normierungsschritt sind in den Formeln \ref{equ:stain_hedab} und \ref{equ:stain_hedab_norm} gezeigt. Die Stainvektoren der einzelnen Farbstoffe entsprechen dabei den Zeilen der Matrix.

\begin{align}\label{equ:stain_hedab}
\mathbf{S} & = 
\begin{bmatrix}
0.18 & 0.20 & 0.08\\
0.01 & 0.13 & 0.01\\
0.10 & 0.21 & 0.29
\end{bmatrix}
\\
\mathbf{S_{norm}} & = 
\begin{bmatrix}
0.65 & 0.70 & 0.29\\
0.07 & 0.99 & 0.11\\
0.27 & 0.57 & 0.78
\end{bmatrix}
\end{align}

Für eine bestimmte Färbemethode sind die so ermittelten Werte eine Näherung, wobei sich die Stainvekoren leicht ändern können, je nach verwendeter Kamera, Lichtquelle und dem Alter der Proben. Die optimalen Stainvektoren sind also von Bild zu Bild leicht unterschiedlich, auch wenn die gleichen Farbstoffe verwendet wurden.  

\subsubsection{Spezifische Stainvektoren für ein Bild}\label{sec:stains_bild}

Es gibt Versuche, die Vektoren für jedes Bild neu zu bestimmen, welche implizit davon ausgehen, dass es Pixel im Bild gibt, welche eindeutig einem Farbstoff zuzuordnen sind. Es sollte also Stellen geben, an denen keine Überlappung stattfindet. 

\paragraph{Macenko}\label{sec:macenko}

Zunächst einmal soll der Vorschlag von \citeeig{macenko2009method} vorgestellt werden, welcher die folgenden Schritte umfasst:
\begin{itemize}
\item{Start: RGB-Bild}
\item{RGB $\rightarrow$ OD}
\item{Betrachten aller Werte mit OD-Intensität größer einem Schwellwert $\beta$, wobei 0.15 empirisch als optimaler Schwellwert bestimmt wurde. Durch dieses Vorgehen sollen nur Pixel mit relevanter Farbinformation berücksichtigt werden.}
\item{Berechnen der Korrelationsmatrix und der zugehörigen SVD(Singular Value Decomposition)}
\item{Berechnen einer Ebene aus den zwei Eigenvektoren, die zu den beiden größten Eigenwerten gehören.}
\item{Projektion aller OD-Pixel auf diese Ebene}
\item{Histogramm über die Winkel, welche die projizierten Pixel mit dem ersten Eigenvektor einschließen}
\item{Bestimmen des robusten Minimum und Maximum in diesem Histogramm}
\item{Rücktransformation in den OD-Raum, Minimum und Maximum entsprechen den Stainvektoren}
\end{itemize} 

Die Logik hinter diesem Vorgehen ist, dass durch das Wählen von Minimum und Maximum, jeder Wert dazwischen als lineare Summe dieser beiden Vektoren ausdrückbar ist. Abbildung \ref{fig:hist_angle} zeigt ein Beispiel für ein Histogramm über die Winkel, Grafik \ref{fig:} zeigt das Ergebnis einer Color Deconvolution mit den gefundenen Stainvektoren.
\begin{figure}[h]
\center
\includegraphics[width = 0.7\textwidth]
{pics/StandTechnik/hist_angle_macenko}
\caption[Winkelhistogramm Macenko]{Beispiel für ein Histogramm über die Winkel, welche die projizierten Punkte mit der ersten Hauptachse einschließen. Daraus zu bestimmen sind das robuste Minimum und Maximum.\label{fig:hist_angle} }
\end{figure}
\begin{figure}[h]
\center
\includegraphics[width = 0.9\textwidth]
{pics/StandTechnik/cd_macenko}
\caption[Color Deconvolution nach Macenko]{Links oben: originales Bild, unten das Bild aufgeteilt nach den beiden Grundfarbstoffen. Dritter Kanal rechts oben, welcher in diesem Beispiel fast leer erscheint.\label{fig:cd_macenko} }
\end{figure}

\citeauthor{macenko2009method} liefern auch einen Ansatz für die Normalisierung. Hierbei wird für jeden vorkommenden Farbstoff ein Histogramm berechnet, welches jedoch nur jene Pixel berücksichtigt, die überwiegend diesen Farbstoff beinhalten.
Die Histogramme werden anschließend so skaliert, dass alle das gleiche Pseudomaximum haben um sie miteinander vergleichbar zu machen\ref{sec:skalierung}. Hierbei wird vor allem berücksichtigt, dass Proben gebleicht worden sein könnten und dieser Effekt reduziert. Allerdings wird nicht berücksichtigt, dass sich die Proben auch inhaltlich stark unterscheiden könnten. Das Ergebnis der Anpassung zweier Bilder ist in Grafik \ref{fig:macenko_result} gezeigt.

\begin{figure}[h]\centering
\subfloat[Originale Bilder]{
\includegraphics[width=0.9\textwidth]
{pics/StandTechnik/macenko_src}\label{fig:macenko_src}}
\quad
\subfloat[Farbnormalisierte Bilder]{
\includegraphics[width=0.9\textwidth]
{pics/StandTechnik/macenko_norm}\label{fig:macenko_norm}}
\quad
\caption[Beispiel Farbnormalisierung Macenko]{In der oberen Zeile sind zwei verschiedene, originale hämatologische Bilder zu sehen, welche beide mit Hämatoxylin und Eosin gefärbt wurden, aber trotzdem deutliche Unterschiede in der Erscheinung aufweisen. Unten ist das Ergebnis der Normalisierung zu sehen. \label{fig:macenko_result}}
\end{figure}

\paragraph{Khan}\label{sec:khan}

Eine andere Methode, welche auf Maschinellem Lernen basiert, wird von \citeeig{khan2014nonlinear} vorgeschlagen. Hierbei soll ein Klassifikator trainiert werden, welcher für jedes Pixel angibt, von welchem Farbstoff es mehrheitlich geprägt ist, bzw. ob es zum Hintergrund gehört.

\citeauthor{khan2014nonlinear} führen als bildspezifisches Merkmal einen sogenannten "Stain Color Descriptor"(SCD) ein.
Sei

$\mathbf{I} = \lbrace I_1,I_2,\ldots,I_k \rbrace$,

ein Set von $k$ Trainingsbildern, dann gibt es ein Set korrespondierender SCDs

$\mathbf{\hat H} = \lbrace \hat{H_1},\hat{H_1},\ldots,\hat{H_k}\rbrace$.

Hierfür werden zunächst alle Trainingsbilder mit Hilfe eines Oct-Tree quantisiert. Der Farbraum wird zunächst in acht Unterräume unterteilt, was durch eine gleichmäßige Unterteilung jedes Farbkanals in zwei Bereiche erreicht wird. Diese Unterräume werden rekursiv wieder in acht Teile zerlegt, bis die Anzahl an Pixeln, die durch diesen Bereich repräsentiert werden unterhalb eines Grenzwert liegt. Das Ziel von \citeauthor{khan2014nonlinear} ist ein Oct-Tree mit 255 Blättern \color{red}(rechnerisch gar nicht möglich, $Sum != 1+x*7, x \in \mathbb{N}$)\color{black} weshalb sie nach der Zerlegung diejenigen Knoten mit der geringsten Zahl an Pixeln wieder zusammenfügen, solange bis sie die gewünschte Zahl erreicht haben.

Die Quantisierung jedes Bildes ergibt ein Set 
$\mathbf{H} = \lbrace H_1, H_2,\ldots,H_k$, wobei jedes Histogramm $H_i$ 255 Elemente hat. Zur Berechnung des korrespondierenden SCD $\hat{H_i}$ wird zunächst ein mittlerer Vektor $\bar H$ und die Kovarianzmatrix $\Sigma_h$ berechnet. Um eine lineare Dimensionsreduktion durchzuführen wird die Eigenvektormatrix $\mathbf {E}^r_h$ bestimmt, wobei $r$ die Zieldimension darstellt. Die Autoren stellten dabei für $r \> 1$ keine signifikante Verbesserung der Klassifikationsergebnisse fest. Formel \ref{equ:khan_dimreduc} zeigt die Projektion eines Histograms $H_i$ in den $r$-dimensionalen Raum, welcher von den Eigenvektoren aufgespannt wird, die zu den $r$ größten Eigenwerten gehören.
\begin{equation}\label{equ:khan_dimreduc}
\hat{H_i} = \mathbf{E}^r_h\left(H_i - \bar{H}\right)
\end{equation}

Der zur Zuordnung zu einer Klasse verwendete Merkmalsvektor ist folgendermaßen aufgebaut: $\mathcal{F} = \lbrack R,G,B, \hat{H} \rbrack$. Die Werte $R$,$G$ und $B$ entsprechen dabei den Werten aus den entsprechenden Kanälen eines RGB-Bildes. 
Die Wahrscheinlichkeit, mit der ein Pixel einem Farbstoff $s_n$ zuzuordnen ist, wird mittels Formel \ref{equ:khan_prob_output}
\begin{equation}\label{equ:khan_prob_output}
P(s_n \mid \mathcal{F}) = \frac{P_{s_n}(s_n\mid \mathcal{F})}{P_{s_1}(s_1\mid \mathcal{F})+P_{s_2}(s_2\mid \mathcal{F})+P_{s_{bgd}}(bgd\mid \mathcal{F})}
\end{equation}
Die berechnete Wahrscheinlichkeit wird für zwei verschiedene Zwecke genutzt:
\begin{itemize}
\item{Berechnung der normalisierten Stainvektoren für jede Klasse $s_n$.}
\item{Zuordnung zu einer Klasse $\theta(c) in \lbrace \text{GEFÄRBT, HINTERGRUND, ANDERES}\rbrace$ mit Hilfe der folgenden Regel \ref{equ:thres_rule}:
\begin{align}\label{equ:thres_rule}
&if \quad P(bgd\mid\mathcal{F} > T_{bgd}:\quad &&\zeta(c)= \text{HINTERGRUND}\nonumber \\
&elseif \quad P(s_n\mid\mathcal{F} > T_{fgd}:\quad &&\zeta(c)= \text{STAINED}\\
&else \quad \quad &&\zeta(c) = \text{OTHER}\nonumber
\end{align}}
$T_{bgd}$ und $T_{fgd}$ sind dabei Grenzwerte für die jeweiligen Entscheidungen. \citeauthor{khan2014nonlinear} geben beide mit $0.75$ an und stellen fest, dass die Wahrscheinlichkeiten in den meisten Fällen entweder nahe $0$ bzw. $1$ liegen, weshalb die Grenzwerte sehr stabil sind.
\end{itemize} 

Eine Übersicht über den Klassifikationsvorgangs von \citeauthor{khan2014nonlinear} gibt Abbildung \ref{fig:khan_classifier}.
\begin{figure}[h]
\center
\includegraphics[width = 0.9\textwidth]
{pics/StandTechnik/khan_classifier}
\caption[Klassifikationsvorgang Khan]{Übersicht über den Klassifikationsansatz von \citeauthor{khan2014nonlinear}.\label{fig:khan_classifier} }
\end{figure}


\subsection{Histogrammanpassung}\label{sec:histogramm}
Histogramme sind eine Möglichkeit zur Beschreibung eines Bildes, weswegen viele Farbanpassungsalgorithmen darauf basieren, diese zu vereinheitlichen. Im folgenden sollen einige Möglichkeiten vorgestellt, wie diese Anpassung aussehen kann. Der Fokus liegt hierbei nicht auf einem verwendeten Farbraum, sondern darauf, wie die Histogramme beeinflusst werden. 

\subsubsection{Histogrammequalisierung}\label{sec:equalisierung}

Bei dieser Methode, wird eine Gleichverteilung für alle Intensitäten angestrebt. Der Effekt wird sichtbar, wenn man das kumulative Histogramm betrachtet. Der Kurvenverlauf nähert sich nach der Anpassung einer Ursprungsgerade an. Ein Beispiel wie sich die Anpassung auswirkt ist in Abbildung \ref{fig:EQGraubild} gezeigt.

\begin{figure}[h]\centering
\subfloat[Originales Grauwertbild BLALBLA]{
\includegraphics[width=0.45\textwidth]
{pics/StandTechnik/800px-Unequalized_Hawkes_Bay_NZ}\label{fig:unequalized}}
\quad
\subfloat[Originales Histogramm in roter Farbe und kumulatives Histogramm mit schwarzer Linie BLALBA]{
\includegraphics[width=0.45\textwidth]
{pics/StandTechnik/712px-Unequalized_Histogram}\label{fig:histoUn}}
\quad
\subfloat[Ausgeglichenes Grauwertbild BLABLA]{
\includegraphics[width=0.45\textwidth]
{pics/StandTechnik/800px-Equalized_Hawkes_Bay_NZ}\label{fig:equalized}}
\quad
\subfloat[Ausgeglichenes Histogramm in Rot mit dem annähernd linearen kumulativen Histogramm in Schwarz BLABLA]{
\includegraphics[width=0.45\textwidth]
{pics/StandTechnik/712px-Equalized_Histogram}\label{fig:histoEq}}
\quad
\caption[Beispiel einer Histogrammequalisierung]{Beispiel einer Histogrammequalisierung \label{fig:EQGraubild}}
\end{figure}


Im Gegensatz zu einem klassischem Histogramm, bei welchem die Anzahl bzw. der Anteil der Pixel mit einen bestimmten Wert betrachtet wird, werden hier die Pixel berücksichtigt, welche kleiner oder gleich diesem Wert sind. Der Verlauf eines kumulativen Histogramms ist aus diesem Grund immer monoton steigend.

\subsubsection{Histogrammspezifikation}\label{sec:spezifikation}

Auch bei der Histogrammspezifikation spielt das kumulative Histogramm eine wichtige Rolle. Im Gegensatz zur in Abschnitt \ref{sec:equalisierung} beschriebenen Equalisierung, ist der Zielverlauf der Kurve bei der Spezifikation keine Gerade, sondern das kumulative Histogramm eines Referenzbildes. Das Vorgehen soll durch die Abbildung \ref{fig:equalisierung} verdeutlicht werden. Zunächst wird für einen Bin der Quelle der Dichtewert auf der y-Achse des Histogramms gesucht. Derjenige Intensitätswert der Referenz, bei dem die Zielfunktion die gleiche Dichte aufweist, ist der gesuchte Transferwert.  
\begin{figure}[h]
\center
\includegraphics[width = 0.45\textwidth]
{pics/StandTechnik/250px-Histogram_matching}
\caption[Beispiel Histogramspezifikation]{Vorgang bei der Histogrammspezifikation. Die CDF(Cumulated Density Function) eines Bildes $\mathbf{x1}$ soll auf die CDF von Bild $\mathbf{x2}$ abgebildet werden. Die Pfeile verbildlichen dabei das genaue Vorgehen.\label{fig:equalisierung} }
\end{figure}

\subsubsection{Histogrammskalierung}\label{sec:skalierung}
Mit Hilfe von Skalierung kann ein beliebiges Maximum, welches ein Histogramm aufweisen soll, erzwungen werden. Als Zielmaximum kann der maximal mögliche Wert angenommen werden (z.b. bei 8 Bit Farbtiefe 255), das Maximum eines Referenzhistogramms, der Durchschnitt der Maxima eines größeren Datensatzes oder ein willkürlich festgelegter Wert. Angewendet wird das Verfahren u.a. von \citeauthor{macenko2009method}, wobei die vorausgehende Farbraumtransformation in Abschnitt \ref{sec:macenko} näher beschrieben wird. Formel \ref{equ:scale} beschreibt den Zusammenhang zwischen einem angepassten Wert $\hat x_i$ und $x_i$. Der Skalierungsfaktor $k$ ergibt sich dabei aus dem Verhältnis zwischen $m_{ref}$, dem Zielmaximum, und $m$, das dem ursprünglichem Maximum des zu verändernden Histogramms entspricht. Gilt $k > 1$ wird das Histogramm gestreckt, bei $k < 1$ wird das Bild dagegen gestaucht.
\begin{equation}\label{equ:scale}
\hat x_i = \frac{m_{ref}}{m}x_i = kx_i
\end{equation}

\subsubsection{Anpassung von Mittelwert und Standardabweichung}\label{sec:mean_std}
Im vorherigen Abschnitt \ref{sec:skalierung} wurde das Maximum eines Histogramms angepasst. \citeeig{reinhard2001color} schlagen dagegen vor Mittelwert und Standardabweichung des Histogramms zu kontrollieren. Während dies beim Mittelwert über eine einfache Verschiebung des Histogramms möglich ist, wird für die Standardabweichung eine Stauchung bzw. Dehnung benötigt. Formel \ref{equ:mean_std} zeigt den allgemeinen Fall, wobei das Histogramm des Kanals $x$ einer Quelle $src$ dem äquivalenten Kanal der Referenz $ref$ nachempfunden werden soll. Das neue Histogramm wird als $neu$ bezeichnet. Außerdem gilt, dass $\sigma_x$ der Standardabweichung entspricht und $\bar{x}$ dem Mittelwert.
\begin{align}\label{equ:mean_std}
x^{\star} &= x_{src} - \bar{x}_{src}\nonumber\\
\hat{x} &= \frac{\sigma_{x_{src}}}{\sigma_{x_{ref}}}\nonumber\\
x_{neu} &= \hat{x} + \bar{x}_{ref}
\end{align}
Ein Beispiel für die Anpassung nach Reinhard mit natürlichen Aufnahmen ist in Graphik \ref{fig:reinhard} zu sehen. 
\begin{figure}[h]
\center
\includegraphics[width = 0.9\textwidth]
{pics/StandTechnik/Beispiel_reinhard}
\caption[Beispiel für Farbanpassung nach Reinhard]{Beispiel für die Farbanpassung nach Reinhard. Links sieht man das Eingabebild, in der Mitte die normalisierte Version und rechts das Referenzbild.\label{fig:reinhard} }
\end{figure}


\subsubsection{Bspline}\label{sec:bspline}
\citeeig{khan2014nonlinear} schlagen für die Anpassung der Histogramme Bsplines vor. Dieses Konzept erlaubt es Kurven zu modellieren, die ein Set von Kontrollpunkten mittels Teilpolynomen so annähert, dass sie an den Grenzen stetig sind. Der Grad der Stetigkeit ist dabei über den Grad des Bsplines $n$ festgesetzt. Die Kurve ist neben den Kontrollpunkten auch noch vom Knotenvektor $\mathbf{T} =  (t_i)$ beeinflusst, welcher die Parameterintervalle festlegt. Ein Beispiel eines Knotenvektors ist in Abbildung \ref{fig:knotvector} dargestellt.
\begin{figure}[h]
\center
\includegraphics[width = 0.7\textwidth]
{pics/StandTechnik/knotvector}
\caption[Bspline Knotenvektor]{Grundsätzlicher Aufbau eines Knotenvektors der Länge $m+n+1$. $n$ ist der Grad des Bsplines und $m$ die Anzahl der Kontrollpunkte.\label{fig:knotvector}}
\end{figure}

Grundlage für einen Bspline sind die Basisfunktionen $n_i^k(u)$, die nach Formel \ref{equ:bspline_basis} definiert sind. 
\begin{align}\label{equ:bspline_basis}
N^0_i(u) & := 
\begin{cases}
1 &t_i \leq u \le t_{i+1}\\
0 &sonst
\end{cases}\\
N_i^k(u) & := \frac{u-t_i}{t_{i+k}}N^{k-1}_i(u)+\frac{t_{i+k+1}-u}{t_{i+k+1}-t_{i+1}}N^{k-1}_{i+1}(u), k =1,\ldots, n
\end{align}

Die Berechnung eines Bsplines $F$ mit Grad $n$, Kontrollpunkten $\mathbf{D} = \lbrace \mathbf{d}_0, \ldots \mathbf{d}_{m-1}$ und einem Knotenvektor $\mathbf{T}$ erfolgt nach Formel \ref{equ:bspline}
\begin{equation}\label{equ:bspline}
F(u) := \sum^{m-1}_{i=0} N^n_i(u)\mathbf{d}_i 
\end{equation}

Einige wichtige Eigenschaften eines Bsplines sind in der folgenden, nicht vollständigen, Liste aufgeführt:
\begin{itemize}
\item{Keine Endpunktinterpolation}
\item{Fallen $n$ Knoten $t_i$ auf den gleichen Wert, so wird der zugehörige Kontrollpunkt interpoliert}
\item{Fallen $n$ Kontrollpunkte $\mathbf{d}_i$ auf den gleichen Punkt, so wird dieser interpoliert}
\item{Lokale Kontrolle: Für $u \in \lbrack )$ ist die Kurve unabhängig von $\mathbf{d}_j$, wobei $j < i-n$ und $j > i$ gilt.}
\end{itemize}

Die Einsatzmöglichkeit dieses Konzeptes für eine Farbanpassung, liegt nun in der Definition der Kontrollpunkte durch Merkmale des Histogramms. Dabei setzt sich eine solche Stützstelle aus einem Merkmal der Quelle, z.b. dem Mittelwert oder dem Maximum, und dem äquivalenten Merkmal der Referenz zusammen. \citeauthor{khan2014nonlinear} segmentieren das Bild zunächst in drei Bereiche: Gefärbt, Hintergrund und Anderes. Dabei nutzen sie die Ausgabe des Klassifikators, welcher in Abschnitt \ref{sec:khan} beschrieben wurde. Nachdem die Color Deconvolution durchgeführt wurde \ref{sec:color_deconvolution}, werden für jeden Kanal separat die Anpassung mittels Bspline festgelegt. Hierzu wird für jeden der drei segmentierten Bereiche ein Histogramm gebildet und das robuste Minimum und Maximum sowie der Mittelwert bestimmt (Abbildung \ref{fig:cd_histograms}). Für jeden Kanal gibt es demnach neun Merkmale, was wiederum zu neun Kontrollpunkten für den Bspline führt. Optisch bzw. chemisch gesättigte Pixel sollen nicht verändert werden, weshalb zusätzliche Stützstellen entlang der Hauptachse eingeführt werden, damit die Sättigungsstellen interpoliert werden. Der beispielhafte Verlauf eines Bsplines für einen Kanal ist in Abbildung \ref{fig:cd_bspline} gezeigt.
\begin{figure}[h]
\center
\includegraphics[width = 0.4\textwidth]
{pics/StandTechnik/cd_histograms}
\caption[Khan Histogramme]{Histogramme von drei verschiedene Regionen für einen Kanal nach CD.\label{fig:cd_histograms}}
\end{figure}
\begin{figure}[h]
\center
\includegraphics[width = 0.7\textwidth]
{pics/StandTechnik/cd_bspline}
\caption[Khan Bspline]{Bspline (blaue Linie) zur Anpassung eines CD-Kanals nach Khan. Auf der x-Achse der ursprüngliche Wert des Quellbildes, auf der y-Achse der neue Wert. Die Kontrollpunkte aus den Histogrammmerkmalen, sowie die zusätzlichen Stützstellen, zur Sicherstellung der Interpolation der Sättigungsstellen sind eingezeichnet.\label{fig:cd_bspline}}
\end{figure}

Eine Gesamtübersicht über den Farbnormalisierungsansatz von Khan gibt Abbildung \ref{fig:khan_normalisation}. Dabei ist auch ein Beispiel für die Wirkung der Methode zu sehen.
\begin{figure}[h]
\center
\includegraphics[width = 0.9\textwidth]
{pics/StandTechnik/khan_pipeline}
\caption[Übersicht Normalisierungsansatz Khan]{Übersicht über den Normalisierungsansatz von \citeauthor{khan2014nonlinear}.\label{fig:khan_normalisation} }
\end{figure}




