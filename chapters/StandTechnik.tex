\chapter[Stand der Technik]{Stand der Technik}\label{sec:stand_der_technik}
Das grundsätzliche Ziel beim Einsatz von Algorithmen zur Farbnormalisierung ist, dass Objekte gleicher Farbe auch ähnliche Pixelwerte haben. Dies sollte unabhängig von der Beleuchtung im Bild sein. Beim Anwendungsfeld der Mikroskopie kommen als Faktoren zusätzlich noch Probendicke und Farbstoffmenge hinzu. Im folgenden Kapitel soll ein Überblick über bestehende Verfahren gegeben werden, wobei der Schwerpunkt, die Normalisierung auf mikroskopischen Bildern, in Abschnitt \ref{sec:mikroskopie_normalisierung} behandelt wird. Zunächst soll jedoch auf Methoden eingegangen werden, welche zwar oft eingesetzt werden, im vorliegenden Fall aufgrund der speziellen Bildakquisition jedoch ungeeignet sind. 
%\section[Allgemeine Farbnormalisierung]{Allgemeine Farbnormalisierung}%\label{sec:allgemeine_normalisierung}
%\color{red}
%Gray World Assumption, Farbkonstanz

%Referenz auf MA Bindl?
%\color{black}

\section{Farbkonstanzalgorithmen}\label{sec:farbkonstanz}
Das menschliche Gehirn ist innerhalb gewisser Grenzen in der Lage die Farbe eines Objektes unabhängig von dessen Beleuchtung zu bestimmen. Diese Fähigkeit ist die Grundlage für eine Gruppe von Ansätzen, die als Farbkonstanzalgorithmen bezeichnet werden.

Das menschliche Auge ist das Vorbild für den sogenannten LMS-Farbraum. Die drei Kanäle entsprechen dabei den unterschiedlichen Zapfen, die auf lang-, mittel- und kurzwelliges Licht reagieren. Nach den Erkenntnissen von Johannes von Kries werden die unterschiedlichen Signale unabhängig voneinander vom Gehirn angepasst. Dieser Zusammenhang wird in der folgenden Formel \ref{equ:kries} dargestellt.
\begin{align}\label{equ:kries}
L_{a} & = k_{L}L\\
M_{a} & = k_{M}M\\
S_{a} & = k_{S}S
\end{align}
$L_{a}$, $M_{a}$ und $S_{a}$ sind hierbei die angepassten Signale. $k_{L}$, $k_{M}$ und $k_{S}$ sind hingegen die unabhängigen Skalierungsfaktoren.
%Für die Bestimmung dieser Faktoren gibt es unterschiedliche Möglichkeiten. Zum einen können sie die Inversen des angenommenen Weißpunktes der Szene sein, zum anderen als Inverse des jeweils maximalen Werts des Kanals.
Eine Annahme die gerne gemacht wird um diese Faktoren zu finden, ist die sogenannte "Grey World Assumption". Es wird dabei davon ausgegangen dass das reflektierte Licht in einem Bild sich zu grau addiert, wobei es Variationen gibt, u.a. bei der Definition von Grau. 
Im einfachsten Fall können die Skalierungsfaktoren entsprechend Formel \ref{equ:grey_world} berechnet werden. Hierbei entspricht $m_{L1}$ dem Mittelwert des L-Kanals einer Referenzaufnahme, $m_{L2}$ dem Mittelwert des L-Kanals aus einer Testaufnahme, usw.  
\begin{align}\label{equ:grey_world}
k_{L}L & = \frac{m_{L2}}{m_{L1}}\\
k_{M}M & = \frac{m_{M2}}{m_{M1}}\\
k_{S}S & = \frac{m_{S2}}{m_{S1}}
\end{align}

Farbkonstanzmodelle treffen Annahmen über das Verhalten von reflektiertem Licht, was sie ungeeignet für die Mikroskopie macht, da hier transmittiertes Licht detektiert wird \cite{khan2014nonlinear}

\section{Histogrammanpassung}\label{sec:histogramm}
Histogramme sind eine Möglichkeit zur Beschreibung eines Bildes, weswegen viele Farbanpassungsalgorithmen darauf basieren, diese zu vereinheitlichen. Im Folgenden sollen einige Möglichkeiten vorgestellt werden, wie diese Anpassung aussehen kann. Der Fokus liegt hierbei nicht auf einem verwendeten Farbraum, sondern darauf, wie die Histogramme beeinflusst werden. 

\subsection{Histogrammequalisierung}\label{sec:equalisierung}

Bei dieser Methode, wird eine Gleichverteilung für alle Intensitäten angestrebt. Der Effekt wird sichtbar, wenn man das kumulative Histogramm betrachtet. Der Kurvenverlauf nähert sich nach der Anpassung einer Ursprungsgerade an. Ein Beispiel wie sich die Anpassung auswirkt ist in Abbildung \ref{fig:EQGraubild} gezeigt.

\begin{figure}[h]\centering
\subfloat[Originales Grauwertbild \cite{url_unequ_image}]{
\includegraphics[width=0.45\textwidth]
{pics/StandTechnik/800px-Unequalized_Hawkes_Bay_NZ}\label{fig:unequalized}}
\quad
\subfloat[Originales Histogramm in roter Farbe und kumulatives Histogramm mit schwarzer Linie \cite{url_unequ_hist}.]{
\includegraphics[width=0.45\textwidth]
{pics/StandTechnik/Unequalized_Histogram_eps}\label{fig:histoUn}}
\quad
\subfloat[Ausgeglichenes Grauwertbild \cite{url_equ_image}]{
\includegraphics[width=0.45\textwidth]
{pics/StandTechnik/800px-Equalized_Hawkes_Bay_NZ}\label{fig:equalized}}
\quad
\subfloat[Ausgeglichenes Histogramm in Rot mit dem annähernd linearen kumulativen Histogramm in Schwarz \cite{url_equ_hist}]{
\includegraphics[width=0.45\textwidth]
{pics/StandTechnik/Equalized_Histogram_eps}\label{fig:histoEq}}
\quad
\caption[Beispiel einer Histogrammequalisierung]{Beispiel einer Histogrammequalisierung \label{fig:EQGraubild}}
\end{figure}


Im Gegensatz zu einem klassischem Histogramm, bei welchem die Anzahl bzw. der Anteil der Pixel mit einen bestimmten Wert betrachtet wird, werden hier die Pixel berücksichtigt, welche kleiner oder gleich diesem Wert sind. Der Verlauf eines kumulativen Histogramms ist aus diesem Grund immer monoton steigend.

\subsection{Histogrammspezifikation}\label{sec:spezifikation}

Auch bei der Histogrammspezifikation spielt das kumulative Histogramm eine wichtige Rolle. Im Gegensatz zur in Abschnitt \ref{sec:equalisierung} beschriebenen Equalisierung, ist der Zielverlauf der Kurve bei der Spezifikation keine Gerade, sondern das kumulative Histogramm eines Referenzbildes. Das Vorgehen soll durch die Abbildung \ref{fig:equalisierung} verdeutlicht werden. Zunächst wird für einen Intensitätswert der Dichtewert auf der y-Achse des Histogramms bestimmt. Derjenige Intensitätswert der Referenz, bei dem die Zielfunktion die gleiche Dichte aufweist, ist der gesuchte Transferwert.  
\begin{figure}[h]
\center
\includegraphics[width = 0.45\textwidth]
{pics/StandTechnik/460px-Histogram_matching}
\caption[Beispiel Histogramspezifikation]{Vorgang bei der Histogrammspezifikation. Die CDF(Cumulated Density Function) eines Bildes $\mathbf{x1}$ soll auf die CDF von Bild $\mathbf{x2}$ abgebildet werden. Die Pfeile verbildlichen dabei das genaue Vorgehen \cite{url_hist_spec}.\label{fig:equalisierung}}
\end{figure}

\section[Farbnormalisierung in der Mikroskopie]{Farbnormalisierung in der Mikroskopie}\label{sec:mikroskopie_normalisierung}
Für Farbnormalisierung im vorliegenden Anwendungsgebiet wird in der Regel der Ansatz verfolgt, ein Bild an ein gegebenes Referenzbild anzugleichen. 
Während die Methoden in den Abschnitten \ref{sec:reinhard}, \ref{sec:macenko} und \ref{sec:khan} eine Farbraumtransformation erfordern, benötigt das Farbranking (\ref{sec:farbranking}) keine Vorverarbeitungsschritte.

\subsection{Farbranking}\label{sec:farbranking}
Farbranking ist ein Verfahren, das von \citeeig{kothari2011automatic} eingeführt wurde. Hierbei werden zunächst die Intensitäten in allen Kanälen jeweils für das Eingangs- und Ausgangsbild sortiert. Anschließend werden zunächst die Positionen für jedes Pixel in den sortierten Listen ermittelt. Die Farbintensitäten bekommen am Ende die Werte zugewiesen, welche sich in den Listen des Referenzbildes an den gleichen Stellen befinden. Dieser Zusammenhang ist in Abbildung \ref{fig:farbranking} für den Fall von Grauwertbildern mit Größe 3x3 dargestellt. Dabei entspricht Bild A dem Referenzbild und Bild B dem Eingangsbild. B' beschreibt das angepasste Ausgabebild. 

\begin{figure}[h]
\center
\includegraphics[width = 0.9\textwidth]{pics/StandTechnik/Farbranking}
\caption[Farbranking]{Links sind Eingangs- und Referenzbild dargestellt, in der Mitte die sortierten Listen und rechts das Ausgabebild. Die farbigen Pfeile sollen den Ablauf nach dem Erstellen der sortierten Listen verdeutlichen. Dabei wird der Pixel links oben im Bild behandelt. Rot: Finden des Pixelwertes in der sortierten Liste. Blau: Wahl des positionsgleichen Wertes aus dem Referenzbild. Grün: Übertrag dieses Wertes an die gleiche Stelle in Bild B' \label{fig:farbranking}}
\end{figure}

Die Schwächen des Verfahrens, zeigen sich vor allem, wenn sich Eingangs- und Referenzbild zu sehr unterscheiden. In diesem Fall kommt es zu Artefakten, bei denen monochrome Flächen nach der Anpassung starke Unterschiede aufweisen.

\color{red}
evtl. Beispielbild
\color{black}

\subsection[Anpassung nach Reinhard]{Anpassung nach Reinhard}\label{sec:reinhard}
Ein andere Methode bei der die Akquisition keine Rolle spielt, wird von \citeeig{reinhard2001color} vorgeschlagen. Das Ziel ist es, die Anpassung in möglichst schwach korrelierenden Kanälen durchzuführen. Ein Farbraum, der diese Eigenschaft für natürliche Bilder erfüllt ist der von \citeeig{ruderman1998statistics} vorgeschlagene $l\alpha\beta$-Raum. Die Umrechnung erfolgt dabei in mehreren Schritten. 
\begin{itemize}
\item{RGB $\rightarrow$ XYZ (Tristimulusraum): 
\begin{equation}\label{equ:rgb_xyz}
\begin{bmatrix}
X\\Y\\Z
\end{bmatrix}
= 
\begin{bmatrix}
0.5141 & 0.3239 & 0.1604\\
0.2651 & 0.6702 & 0.0641\\
0.0241 & 0.1228 & 0.8444
\end{bmatrix}
\begin{bmatrix}
R\\G\\B
\end{bmatrix}
\end{equation}
}
\item{XYZ $\rightarrow$ LMS (vgl. Abschnitt \ref{sec:farbkonstanz}})

\begin{equation}\label{equ:xyz_lms}
\begin{bmatrix}
L\\M\\S
\end{bmatrix}
= 
\begin{bmatrix}
0.3897 & 0.6890 & -0.0787\\
-0.2298 & 1.1834 & 0.0464\\
0.000 & 0.000 & 1.0000
\end{bmatrix}
\begin{bmatrix}
X\\Y\\Z
\end{bmatrix}
\end{equation}
\item{Logarithmus auf dem LMS-Raum}
\item{Logarithmierter LMS $\rightarrow L\alpha\beta$}

\begin{equation}\label{equ:lms_lab}
\begin{bmatrix}
L\\\alpha\\\beta
\end{bmatrix}
= 
\begin{bmatrix}
\frac{1}{\sqrt{3}} & 0 & 0\\
0 & \frac{1}{\sqrt{6}} & 0\\
0 & 0 & \frac{1}{\sqrt{2}}
\end{bmatrix}
\begin{bmatrix}
1 & 1 & 1\\
1 & 1 & -2\\
1 & -1 & 0
\end{bmatrix}
\begin{bmatrix}
log(L)\\log(M)\\log(S)
\end{bmatrix}
\end{equation}
\end{itemize}

Die Umrechnung in Formel \ref{equ:lms_lab} basiert auf einer Hauptachsentransformation, welche von \citeauthor{ruderman1998statistics} auf einem Datensatz natürlicher Fotos durchgeführt wurde. Die Eigenvektoren der gemittelten Kovarianzmatrix finden sich in der Rotationsmatrix dieser Transformation. \citeeig{reinhard2001color} schlagen vor, die Histogramme der dekorrelierten Kanäle mittels Übertragung von Mittelwert und Standardabweichung einzeln anzupassen. Während dies beim Mittelwert über eine einfache Verschiebung des Histogramms möglich ist, wird für die Standardabweichung eine Stauchung bzw. Dehnung benötigt. Formel \ref{equ:mean_std} zeigt den allgemeinen Fall, wobei das Histogramm des Kanals $x$ einer Quelle $src$ dem äquivalenten Kanal der Referenz $ref$ nachempfunden werden soll. Das neue Histogramm wird als $neu$ bezeichnet. Außerdem gilt, dass $\sigma_x$ der Standardabweichung entspricht und $\bar{x}$ dem Mittelwert. 
\begin{align}\label{equ:mean_std}
x^{\star} &= x_{src} - \bar{x}_{src}\nonumber\\
\hat{x} &= \frac{\sigma_{x_{src}}}{\sigma_{x_{ref}}}x^{\star}\nonumber\\
x_{neu} &= \hat{x} + \bar{x}_{ref}
\end{align}
Die Formel \ref{equ:mean_std} wird auf alle Kanäle $l\alpha\beta$ angewendet. Ein Beispiel für die Anpassung nach Reinhard mit natürlichen Aufnahmen ist in Graphik \ref{fig:reinhard} zu sehen. 
\begin{figure}[h]
\center
\subfloat[Original \cite{reinhard2001color}]{
\includegraphics[width = 0.3\textwidth]
{pics/StandTechnik/reinhard1}}
\quad
\subfloat[Referenz \cite{reinhard2001color}]{
\includegraphics[width = 0.3\textwidth]
{pics/StandTechnik/reinhard2}}
\quad
\subfloat[Original an Referenz angepasst \cite{reinhard2001color}]{
\includegraphics[width = 0.3\textwidth]
{pics/StandTechnik/reinhard3}}
\caption[Beispiel für Farbanpassung nach Reinhard]{Beispiel für die Farbanpassung nach Reinhard. In \textbf{(a)} sieht man das Eingabebild, in \textbf{(b)} das Referenzbild und in \textbf{(c)} das normalisierte Bild.\label{fig:reinhard}}
\end{figure}

\subsection{Anpassung nach Macenko}\label{sec:macenko}

Ein Verfahren zur Farbnormalisierung in Mikroskopiebildern, welches auf Color Deconvolution (siehe Kaptitel (\ref{sec:color_deconvolution}) basiert, wird von \citeeig{macenko2009method} vorgeschlagen. Da die Stainvektoren optimalerweise für jedes Bild neu berechnet sollten, ist der erste Teil auf dieses Problem fokussiert. Die Lösung der Autoren ist in folgende Schritte unterteilt:
\begin{itemize}
\item{Start: RGB-Bild}
\item{RGB $\rightarrow$ Optical Density (OD)}
\item{Betrachten aller Werte mit OD-Intensität größer einem Schwellwert $\beta$, wobei 0.15 empirisch als optimaler Schwellwert bestimmt wurde. Durch dieses Vorgehen sollen nur Pixel mit relevanter Farbinformation berücksichtigt werden.}
\item{Berechnen der Korrelationsmatrix und der zugehörigen SVD (Singular Value Decomposition)}
\item{Berechnen einer Ebene aus den zwei Eigenvektoren, die zu den beiden größten Eigenwerten gehören.}
\item{Projektion aller OD-Pixel auf diese Ebene}
\item{Histogramm über die Winkel, welche die projizierten Pixel mit dem ersten Eigenvektor einschließen}
\item{Bestimmen des robusten Minimum und Maximum in diesem Histogramm}
\item{Rücktransformation in den OD-Raum, Minimum und Maximum entsprechen den Stainvektoren}
\end{itemize} 

Die Logik hinter diesem Vorgehen ist, dass durch das Wählen von Minimum und Maximum, jeder Wert dazwischen als lineare Summe dieser beiden Vektoren ausdrückbar ist. Abbildung \ref{fig:hist_angle} zeigt ein Beispiel für ein Histogramm über die Winkel, Abbildung \ref{fig:hist_angle} zeigt das Ergebnis einer Color Deconvolution mit den gefundenen Stainvektoren.
\begin{figure}[h]
\center
\includegraphics[width = 0.5\textwidth]
{pics/StandTechnik/hist_angle_macenko}
\caption[Winkelhistogramm Macenko]{Beispiel für ein Histogramm über die Winkel, welche die projizierten Punkte mit der ersten Hauptachse einschließen. Daraus zu bestimmen sind das robuste Minimum und Maximum.\label{fig:hist_angle} }
\end{figure}
\begin{figure}[h]
\center
\subfloat[Original]{
\includegraphics[width = 0.35\textwidth]{pics/StandTechnik/macenko1}}
\quad
\subfloat[Kanal 3]{
\includegraphics[width = 0.35\textwidth]{pics/StandTechnik/macenko4}}
\quad
\subfloat[Kanal 1]{
\includegraphics[width = 0.35\textwidth]{pics/StandTechnik/macenko2}}
\quad
\subfloat[Kanal 2]{
\includegraphics[width = 0.35\textwidth]{pics/StandTechnik/macenko3}}
\caption[Color Deconvolution nach Macenko]{\textbf{(a)} originales Bild, \textbf{(b)} dritter Kanal, nur geringe Information. \textbf{(c)} und \textbf{(d)} Bild aufgeteilt nach den beiden Grundfarbstoffen.\label{fig:cd_macenko} }
\end{figure}

\citeauthor{macenko2009method} liefern auch einen Ansatz für die Normalisierung. Hierbei wird für jeden vorkommenden Farbstoff ein Histogramm berechnet, welches jedoch nur jene Pixel berücksichtigt, die überwiegend diesen Farbstoff beinhalten.
Die Histogramme werden anschließend so skaliert, dass alle das gleiche Pseudomaximum haben, um sie miteinander vergleichbar zu machen (siehe Formel \ref{equ:scale}). Diese Operation fällt in den Bereich der Histogrammanpassung und hat den Effekt, dass das Histogramm entweder gedehnt oder gestaucht wird. Welche der beiden Möglichkeiten eintritt hängt von der Größe des Skalierungsfaktors $k$ ab. Ist $k < 1$, entspricht dies einer Stauchung, ist $k > 1$ einer Dehnung. $k$ ist dabei abhängig vom realen Maximum $m$ und dem Zielmaximum $m_{ref}$. In Formel \ref{equ:scale} repräsentiert $x_i$ einen Wert aus dem ursprünglichen Histogramm, $\hat x_i$ ist der entsprechende angepasste Wert.

\begin{equation}\label{equ:scale}
\hat x_i = \frac{m_{ref}}{m}x_i = kx_i
\end{equation}

Hierbei wird vor allem berücksichtigt, dass Proben gebleicht worden sein könnten und dieser Effekt reduziert. Allerdings wird nicht berücksichtigt, dass sich die Proben auch inhaltlich stark unterscheiden könnten. Das Ergebnis der Anpassung zweier Bilder ist in Abbildung \ref{fig:macenko_result} gezeigt.

\begin{figure}[h]\centering
\subfloat[Originale Bilder]{
\includegraphics[width=0.9\textwidth]
{pics/StandTechnik/macenko_src}\label{fig:macenko_src}}
\quad
\subfloat[Farbnormalisierte Bilder]{
\includegraphics[width=0.9\textwidth]
{pics/StandTechnik/macenko_norm}\label{fig:macenko_norm}}
\quad
\caption[Beispiel Farbnormalisierung Macenko]{\textbf{(a)} zwei verschiedene, originale hämatologische Bilder, welche beide mit Hämatoxylin und Eosin gefärbt wurden, aber trotzdem deutliche Unterschiede in der Erscheinung aufweisen. \textbf{(b)} Ergebnis der Normalisierung. \cite{macenko2009method} \label{fig:macenko_result}}
\end{figure}

%TODO
\subsection{Anpassung nach Khan}\label{sec:khan}
Ansätze, die das Ziel haben, die Vektoren für jedes Bild neu zu bestimmen, gehen implizit davon aus, dass es Pixel im Bild gibt, welche eindeutig einem Farbstoff zuzuordnen sind. Es sollte also Stellen geben, an denen keine Überlappung stattfindet. 
Neben dem bereits vorgestellten Ansatz von Macenko ist die Methode von \citeeig{khan2014nonlinear} ein weiteres Beispiel für ein solches Verfahren. Neben der Color Deconvolution (siehe Abschnitt\ref{sec:color_deconvolution}) spielt hier Mustererkennung eine wichtige Rolle, da ein Klassifikator trainiert werden soll, welcher für jedes Pixel angibt, von welchem Farbstoff es mehrheitlich geprägt ist, bzw. ob es zum Hintergrund gehört. Diese Information ist sowohl entscheidend für die Berechnung der Stainvektoren, als auch für die spätere Anpassung, für die B-Splines benutzt werden.
Für den Klassifikator führen \citeauthor{khan2014nonlinear} einen sogenannten "Stain Color Descriptor"(SCD) als bildspezifisches Merkmal ein.

Sei $\mathbf{I} = \lbrace I_1,I_2,\ldots,I_k \rbrace$, ein Set von $k$ Trainingsbildern, dann gibt es ein Set korrespondierender SCDs $\mathbf{\hat H} = \lbrace \hat{H_1},\hat{H_1},\ldots,\hat{H_k}\rbrace$.

Hierfür werden zunächst alle Trainingsbilder mit Hilfe eines Octree quantisiert \cite{gervautz1988simple}. Der Farbraum wird zunächst in acht Unterräume unterteilt, was durch eine gleichmäßige Aufteilung jedes Farbkanals in zwei Bereiche erreicht wird. Diese Unterräume werden rekursiv wieder in acht Teile zerlegt, bis die Anzahl an Pixeln, die durch diesen Bereich repräsentiert werden unterhalb eines Grenzwert liegt. In Abbildung \ref{fig:octree} ist der  Aufbau eines Octree dargestellt.
\begin{figure}
\center
\includegraphics[width = 0.6\textwidth]
{pics/StandTechnik/octree}
\caption[Schema Octree]{Aufbau eines Octree: Baumstruktur, bei dem jeder Knoten, der kein Blatt ist, in acht Kindknoten zerlegt wird \cite{octree}. }\label{fig:octree}
\end{figure}
Das Ziel von \citeauthor{khan2014nonlinear} ist ein Baum mit 255 Blättern, weshalb nach der Zerlegung diejenigen Knoten mit der geringsten Zahl an Pixeln wieder zusammenfügt werden, solange bis die gewünschte Zahl erreicht ist.

Die Quantisierung jedes Bildes ergibt ein Set 
$\mathbf{H} = \lbrace H_1, H_2,\ldots,H_k\rbrace$, wobei jedes Histogramm $H_i$ 255 Elemente hat. Zur Berechnung des korrespondierenden SCD $\hat{H_i}$ wird zunächst ein mittlerer Vektor $\bar H$ und die Kovarianzmatrix $\Sigma_h$ berechnet. Um eine lineare Dimensionsreduktion durchzuführen wird die Eigenvektormatrix $\mathbf {E}^r_h$ bestimmt, wobei $r$ die Zieldimension darstellt. Die Autoren stellten dabei für $r > 1$ keine signifikante Verbesserung der Klassifikationsergebnisse fest. Formel \ref{equ:khan_dimreduc} zeigt die Projektion eines Histograms $H_i$ in den $r$-dimensionalen Raum, welcher von den Eigenvektoren aufgespannt wird, die zu den $r$ größten Eigenwerten gehören.
\begin{equation}\label{equ:khan_dimreduc}
\hat{H_i} = \mathbf{E}^r_h\left(H_i - \bar{H}\right)
\end{equation}

Der zur Zuordnung zu einer Klasse verwendete Merkmalsvektor ist folgendermaßen aufgebaut: $\mathcal{F} = \lbrack R,G,B, \hat{H} \rbrack$. Die Werte $R$,$G$ und $B$ entsprechen dabei den Werten aus den entsprechenden Kanälen eines RGB-Bildes. 
Die Wahrscheinlichkeit, mit der ein Pixel einem Farbstoff $s_n$ zuzuordnen ist, wird mittels Formel \ref{equ:khan_prob_output} bestimmt:
\begin{equation}\label{equ:khan_prob_output}
P(s_n \mid \mathcal{F}) = \frac{P_{s_n}(s_n\mid \mathcal{F})}{P_{s_1}(s_1\mid \mathcal{F})+P_{s_2}(s_2\mid \mathcal{F})+P_{s_{bgd}}(bgd\mid \mathcal{F})}
\end{equation}
Die berechnete Wahrscheinlichkeit wird für zwei verschiedene Zwecke genutzt:
\begin{itemize}
\item{Berechnung der normalisierten Stainvektoren für jede Klasse $s_n$.}
\item{Zuordnung zu einer Klasse $\theta(c) \text{ in } \lbrace \text{GEFÄRBT, HINTERGRUND, SONSTIGES}\rbrace$ mit Hilfe der folgenden Regel \ref{equ:thres_rule}:
\begin{align}\label{equ:thres_rule}
&if \quad P(bgd\mid\mathcal{F} > T_{bgd}:\quad &&\zeta(c)= \text{HINTERGRUND}\nonumber \\
&elseif \quad P(s_n\mid\mathcal{F} > T_{fgd}:\quad &&\zeta(c)= \text{GEFÄRBT}\\
&else \quad \quad &&\zeta(c) = \text{SONSTIGES}\nonumber
\end{align}}
$T_{bgd}$ und $T_{fgd}$ sind dabei Grenzwerte für die jeweiligen Entscheidungen. \citeauthor{khan2014nonlinear} geben beide mit $0.75$ an und stellen fest, dass die Wahrscheinlichkeiten in den meisten Fällen entweder nahe $0$ bzw. $1$ liegen, weshalb die Grenzwerte sehr stabil sind.
\end{itemize} 

Eine Übersicht über den Klassifikationsvorgangs von \citeauthor{khan2014nonlinear} gibt Abbildung \ref{fig:khan_classifier}.
\begin{figure}[h]
\center
\includegraphics[width = 0.9\textwidth]
{pics/StandTechnik/khan_classifier}
\caption[Klassifikationsvorgang Khan]{Übersicht über den Klassifikationsansatz von \citeeig{khan2014nonlinear}.\label{fig:khan_classifier} }
\end{figure}

\citeeig{khan2014nonlinear} schlagen für die Anpassung der Histogramme B-Splines vor. Die Einsatzmöglichkeit dieses Konzeptes für eine Farbanpassung liegt in der Definition der Kontrollpunkte durch Merkmale des Histogramms. Dabei setzt sich eine solche Stützstelle aus einem Merkmal der Quelle, z.B. dem Mittelwert oder dem Maximum, und dem äquivalenten Merkmal der Referenz zusammen. \citeauthor{khan2014nonlinear} segmentieren das Bild zunächst in drei Bereiche: Gefärbt, Hintergrund und Sonstiges. Dabei nutzen sie die Ausgabe des Klassifikators, welcher in Abschnitt \ref{sec:khan} beschrieben wurde. Nachdem die Color Deconvolution durchgeführt wurde, wird für jeden Kanal separat die Anpassung mittels B-Spline festgelegt. Hierzu wird für jeden der drei segmentierten Bereiche ein Histogramm gebildet und das robuste Minimum und Maximum sowie der Mittelwert bestimmt (Abbildung \ref{fig:cd_histograms}). Für jeden Kanal gibt es demnach neun Merkmale, was wiederum zu neun Kontrollpunkten für den B-Spline führt. Optisch bzw. chemisch gesättigte Pixel sollen nicht verändert werden, weshalb zusätzliche Stützstellen entlang der Hauptachse eingeführt werden, damit die Sättigungsstellen interpoliert werden. Die Werte des Knotenvektors $\mathbf{T}$ werden mit Hilfe einer Thikonov regularization optimiert \cite{hansen1998rank}. Der beispielhafte Verlauf eines B-Splines für einen Kanal ist in Abbildung \ref{fig:cd_bspline} gezeigt.
\begin{figure}[h]
\center
\includegraphics[width = 0.4\textwidth]
{pics/StandTechnik/cd_histograms}
\caption[Khan Histogramme]{Histogramme von drei verschiedene Regionen für einen Kanal nach Color Deconvolution.\label{fig:cd_histograms}}
\end{figure}
\begin{figure}[h]
\center
\includegraphics[width = 0.7\textwidth]
{pics/StandTechnik/cd_bspline}
\caption[Khan B-Spline]{B-Spline (blaue Linie) zur Anpassung eines CD-Kanals nach Khan. Auf der x-Achse der ursprüngliche Wert des Quellbildes, auf der y-Achse der neue Wert. Die Kontrollpunkte aus den Histogrammmerkmalen, sowie die zusätzlichen Stützstellen, zur Sicherstellung der Interpolation der Sättigungsstellen sind eingezeichnet.\label{fig:cd_bspline}}
\end{figure}

Eine Gesamtübersicht über den Farbnormalisierungsansatz von Khan gibt Abbildung \ref{fig:khan_normalisation}. Dabei ist auch ein Beispiel für die Wirkung der Methode zu sehen.
\begin{figure}[h]
\center
\includegraphics[width = 0.9\textwidth]
{pics/StandTechnik/khan_pipeline}
\caption[Übersicht Normalisierungsansatz Khan]{Übersicht über den Normalisierungsansatz von \citeeig{khan2014nonlinear}.\label{fig:khan_normalisation} }
\end{figure}

%TODO

